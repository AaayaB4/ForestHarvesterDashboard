<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Forest Harvester Head Performance</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- font from google (poppins font style regular 400 and semi 600 used here) -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/static/style.css">
</head>



<body>

    <header>
        <a href="#" class="header">Forest Harvester Head Performance</a>
    </header>

    <div class="main">

        <div class="line-chart">
            <select id="parameterSelect" onchange="updateChart()">
                <option value="hydraulicPressure">Hydraulic Pressure (bar)</option>
                <option value="oilTemperature">Hydraulic Oil Temperature (°C)</option>
                <option value="sawBladeRPM">Saw Blade RPM</option>
                <option value="fuelConsumption">Fuel Consumption (L/hour)</option>
                <option value="bladeSharpness">Blade Sharpness Level (%)</option>
            </select>

            <canvas id="myChart"></canvas>
        </div>

        <div class="status-and-alert">

            <div class="status">
                <h3>Status Table</h3>
                <table>
                    <tr>
                        <th>Hydraulic Pressure (bar)</th>
                        <td>290</td>
                        <td><span class="status-light green"></span></td>
                    </tr>
                    <tr>
                        <th>Hydraulic Oil Temperature (°C)</th>
                        <td>75</td>
                        <td><span class="status-light green"></span></td>
                    </tr>
                    <tr>
                        <th>Saw Blade RPM</th>
                        <td>2600</td>
                        <td><span class="status-light green"></span></td>
                    </tr>
                    <tr>
                        <th>Fuel Consumption (L/hour)</th>
                        <td>22</td>
                        <td><span class="status-light yellow"></span></td>
                    </tr>
                    <tr>
                        <th>Blade Sharpness Level (%)</th>
                        <td>50</td>
                        <td><span class="status-light red"></span></td>
                    </tr>
                </table>
            </div>
        
            <div class="alert">
                <h3>Prediction Model Alert</h3>
                <div class="alert-dynamic">
                    <h3 id="alert-message">Maintenance Due!</h3>
                    <h4>Confidence Level</h4>
                    <h4>85%</h4>
                </div>
            </div>

        </div>

    </div>

    <script>
        const ctx = document.getElementById('myChart').getContext('2d');
        const dataSets = {
            hydraulicPressure: [],
            oilTemperature: [],
            sawBladeRPM: [],
            fuelConsumption: [],
            bladeSharpness: []
        };
        
        let chart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: ['t-5', 't-4', 't-3', 't-2', 't-1', 't'],
                datasets: [{
                    label: 'Hydraulic Pressure (bar)',
                    data: dataSets.hydraulicPressure,
                    borderColor: 'blue',
                    borderWidth: 3,
                    fill: false
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                onClick: () => cycleParameter(),
                plugins: {
                    legend: {
                        display: false
                    }
                },
                scales: {
                    x: {
                        title: {
                            display: true,
                            text: 'time (hrs)',
                            color: 'black',
                            font: {
                                size: 13
                            }
                        },
                        ticks: {
                            color: 'black' 
                        }
                    },
                    y: {
                        beginAtZero: true,
                        title: {
                            font:{
                                color: 'black',
                            }
                        },
                        ticks: {
                            color: 'black' 
                        }
                    }
                }
            }
        });

        function updateChart() {
            const selectedParam = document.getElementById('parameterSelect').value;
            chart.data.datasets[0].data = dataSets[selectedParam];
            chart.data.datasets[0].label = document.getElementById('parameterSelect').selectedOptions[0].text;
            chart.update();
        }

        function cycleParameter() {
            let options = document.getElementById('parameterSelect').options;
            let selectedIndex = document.getElementById('parameterSelect').selectedIndex;
            let nextIndex = (selectedIndex + 1) % options.length;
            document.getElementById('parameterSelect').selectedIndex = nextIndex;
            updateChart();
        }

        function updateStatusTable(sensorData, colors) {
            const table = document.querySelector('.status table');
            const rows = table.getElementsByTagName('tr');
            
            rows[0].getElementsByTagName('td')[0].textContent = sensorData.Hydraulic_Pressure;
            rows[0].getElementsByTagName('td')[1].getElementsByClassName('status-light')[0].className = `status-light ${colors.Hydraulic_Pressure}`;
            
            rows[1].getElementsByTagName('td')[0].textContent = sensorData.Hydraulic_Oil_Temperature;
            rows[1].getElementsByTagName('td')[1].getElementsByClassName('status-light')[0].className = `status-light ${colors.Hydraulic_Oil_Temperature}`;
            
            rows[2].getElementsByTagName('td')[0].textContent = sensorData.Saw_Blade_RPM;
            rows[2].getElementsByTagName('td')[1].getElementsByClassName('status-light')[0].className = `status-light ${colors.Saw_Blade_RPM}`;
            
            rows[3].getElementsByTagName('td')[0].textContent = sensorData.Fuel_Consumption;
            rows[3].getElementsByTagName('td')[1].getElementsByClassName('status-light')[0].className = `status-light ${colors.Fuel_Consumption}`;
            
            rows[4].getElementsByTagName('td')[0].textContent = sensorData.Blade_Sharpness_Level;
            rows[4].getElementsByTagName('td')[1].getElementsByClassName('status-light')[0].className = `status-light ${colors.Blade_Sharpness_Level}`;
        }

        function updateAlertMessage(prediction) {
            const alertMessage = document.getElementById('alert-message');
            alertMessage.textContent = prediction;
            
            // Update color based on prediction
            if (prediction === 'All good') {
                alertMessage.style.color = 'green';
            } else if (prediction === 'Maintenance Due!') {
                alertMessage.style.color = 'darkorange';
            } else {
                alertMessage.style.color = 'red';
            }
        }

        function updateData() {
            fetch('/predict', {
                method: 'POST'
            })
            .then(response => response.json())
            .then(data => {
                const sensorData = data.sensor_data[0];
                const colors = data.color[0];
                const prediction = data.prediction;

                // Update datasets
                dataSets.hydraulicPressure.push(sensorData.Hydraulic_Pressure);
                dataSets.oilTemperature.push(sensorData.Hydraulic_Oil_Temperature);
                dataSets.sawBladeRPM.push(sensorData.Saw_Blade_RPM);
                dataSets.fuelConsumption.push(sensorData.Fuel_Consumption);
                dataSets.bladeSharpness.push(sensorData.Blade_Sharpness_Level);

                // Keep only last 6 points
                Object.keys(dataSets).forEach(key => {
                    if (dataSets[key].length > 6) {
                        dataSets[key].shift();
                    }
                });

                // Update UI
                updateChart();
                updateStatusTable(sensorData, colors);
                updateAlertMessage(prediction);
            })
            .catch(error => console.error('Error:', error));
        }

        // Initial update
        updateData();

        // Update every 2 seconds
        setInterval(updateData, 2000);
    </script>
</body>

</html>
